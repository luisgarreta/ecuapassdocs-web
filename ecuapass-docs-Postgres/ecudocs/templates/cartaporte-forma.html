{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- For autocomplete: Include necessary CSS and JS files, e.g., jQuery UI -->
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

	<title>Creador de Cartas de Porte</title>

    <style>
        body 
            /* Add any other styles you need for your body */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita las barras de desplazamiento del cuerpo del documento */
        }

        #container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: visible; 
        }

        .container {
            position: absolute;
            left: 00px; 
            top: 00px; 
            width: 1100px; 
            height: 1424px; 

            background: rgba(55, 55, 255, 0.2); 
            padding: 00px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 1.0); 
        }

        #background {
            background-image: url('{% static "ecudocs/images/image-cartaporte-vacia-SILOG.png" %}');
            #background-size: 1699px 2200px; /* Tama√±o fijo de la imagen de fondo */
            #background-size: cover; /* Adjust as needed */
            background-repeat: no-repeat;
            width: 1100px; /* Ancho fijo de la imagen de fondo */
            height: 1424px; /* Alto fijo de la imagen de fondo */
        }


		/* Style for the form header (containing the pdf-clonar button) */
		.form-header {
		  text-align: center;
		  margin-bottom: 10px;
		}

		.top-panel {
		  background-color: #fff0ff;
		  padding: 03px;
		  text-align: center;
		}

		form {
		  display: flex;
		  flex-direction: column; /* Align items in a column */
		  align-items: center;
		  padding: 10px;
		}		

		#pdf_preliminar_btn {
		  background-color: #7CFC00;
		  color: black;
		}

		#pdf_original_btn {
		  background-color: #FFFF00;
		  color: black;
		}

		#pdf_copia_btn {
		  background-color: #F0FFFF;
		  color: black;
		}

		#pdf_clonar_btn {
		  background-color: #ADD8E6;
		  color: black;
		}		

		textarea {
		  resize: none; /* "none" disables resizing */
		  overflow: hidden ; /* Disable scrolling */
		  white-space: pre-line; /* Wrap and preserve line breaks */
		}

    	/* Establece las coordenadas (X, Y) y el ancho y alto de los campos de texto */
		#txt00 { position: absolute; left: 797px; top: 82px; width: 233px; height: 28px; }
		#txt01 { position: absolute; left: 40px; top: 162px; width: 501px; height: 103px; }
		#txt02 { position: absolute; left: 40px; top: 302px; width: 501px; height: 63px; }
		#txt03 { position: absolute; left: 40px; top: 397px; width: 501px; height: 58px; }
		#txt04 { position: absolute; left: 40px; top: 492px; width: 501px; height: 78px; }
		#txt05 { position: absolute; left: 555px; top: 142px; width: 501px; height: 58px; }
		#txt06 { position: absolute; left: 555px; top: 232px; width: 501px; height: 33px; }
		#txt07 { position: absolute; left: 555px; top: 302px; width: 501px; height: 63px; }
		#txt08 { position: absolute; left: 555px; top: 397px; width: 501px; height: 58px; }
		#txt09 { position: absolute; left: 555px; top: 492px; width: 501px; height: 78px; }
		#txt10 { position: absolute; left: 40px; top: 647px; width: 93px; height: 289px; }
		#txt11 { position: absolute; left: 147px; top: 647px; width: 103px; height: 289px; }
		#txt12 { position: absolute; left: 265px; top: 647px; width: 513px; height: 289px; }
		#txt13_1 { position: absolute; left: 797px; top: 677px; width: 121px; height: 13px; }
		#txt13_2 { position: absolute; left: 935px; top: 677px; width: 121px; height: 13px; }
		#txt14 { position: absolute; left: 797px; top: 777px; width: 121px; height: 13px; }
		#txt15 { position: absolute; left: 935px; top: 777px; width: 121px; height: 13px; }
		#txt16 { position: absolute; left: 795px; top: 869px; width: 263px; height: 67px; }
		#txt17_11 { position: absolute; left: 112px; top: 997px; width: 114px; height: 11px; }
		#txt17_12 { position: absolute; left: 112px; top: 1018px; width: 114px; height: 11px; }
		#txt17_13 { position: absolute; left: 112px; top: 1038px; width: 114px; height: 11px; }
		#txt17_14 { position: absolute; left: 112px; top: 1059px; width: 114px; height: 11px; }
		#txt17_21 { position: absolute; left: 240px; top: 997px; width: 80px; height: 11px; }
		#txt17_22 { position: absolute; left: 240px; top: 1018px; width: 80px; height: 11px; }
		#txt17_23 { position: absolute; left: 240px; top: 1038px; width: 80px; height: 11px; }
		#txt17_24 { position: absolute; left: 240px; top: 1059px; width: 80px; height: 11px; }
		#txt17_31 { position: absolute; left: 334px; top: 997px; width: 100px; height: 11px; }
		#txt17_32 { position: absolute; left: 334px; top: 1018px; width: 100px; height: 11px; }
		#txt17_33 { position: absolute; left: 334px; top: 1038px; width: 100px; height: 11px; }
		#txt17_34 { position: absolute; left: 334px; top: 1059px; width: 100px; height: 11px; }
		#txt17_41 { position: absolute; left: 447px; top: 997px; width: 94px; height: 11px; }
		#txt17_42 { position: absolute; left: 447px; top: 1018px; width: 94px; height: 11px; }
		#txt17_43 { position: absolute; left: 447px; top: 1038px; width: 94px; height: 11px; }
		#txt17_44 { position: absolute; left: 447px; top: 1059px; width: 94px; height: 11px; }
		#txt18 { position: absolute; left: 40px; top: 1103px; width: 503px; height: 32px; }
		#txt19 { position: absolute; left: 40px; top: 1171px; width: 503px; height: 40px; }
		#txt20 { position: absolute; left: 40px; top: 1247px; width: 503px; height: 96px; }
		#txt21 { position: absolute; left: 555px; top: 975px; width: 503px; height: 95px; }
		#txt22 { position: absolute; left: 555px; top: 1103px; width: 503px; height: 108px; }
		#txt23 { position: absolute; left: 555px; top: 1333px; width: 503px; height: 10px; }
		#txt24 { position: absolute; left: 477px; top: 1357px; width: 173px; height: 23px; }

    </style>
		<!-- For PDF -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</head>
<body>
	<div id="background"></div>
		<form action="{% url 'ecudocs:cartaporte' %}" method="post" id="forma_pdf" target="_blank">
			<div class="container">
				{% csrf_token %}
				<!-- Panel superior que muestra cuatro opciones para realizar con el documento -->
				<div class="top-panel">
					<button type="submit" id="pdf_preliminar_btn" name="action" value="preliminar">PDF preliminar</button>
					<button type="submit" id="pdf_original_btn"  name="action" value="original">PDF original</button>
					<button type="submit" id="pdf_copia_btn" name="action" value="copia">PDF copia</button>
					<button type="submit" id="pdf_clonar_btn" name="action" value="clonar">Clonar</button>
				</div>
				<!--------------------------------------------------------------->
				<!----------------------- Input fields -------------------------->
				<!--------------------------------------------------------------->
				<textarea name="txt00" id="txt00" class="input_numero" readonly>PRELIMINAR</textarea>
				<textarea name="txt01" id="txt01" class="input_numero" hidden></textarea>
				<!-- input_empresa: 02, 03, 04, 05: Nombre, dir, pais, rut -->
				<textarea name="txt02" id="txt02" class="input_empresa"></textarea>
				<textarea name="txt03" id="txt03" class="input_empresa"></textarea>
				<textarea name="txt04" id="txt04" class="input_empresa"></textarea>
				<textarea name="txt05" id="txt05" class="input_empresa"></textarea>
				<!-- input_lugar: 06, 07, 08: Ciudad, Pais, Fecha -->
				<textarea name="txt06" id="txt06" class="input_lugar"></textarea>
				<textarea name="txt07" id="txt07" class="input_lugar"></textarea>
				<textarea name="txt08" id="txt08" class="input_lugar"></textarea>

				<textarea name="txt09" id="txt09" class="input_condiciones"></textarea>

				<!-- input_bultos: 10, 11, 12: Cantidad, Marca, Descripcion -->
				<textarea name="txt10" id="txt10" class="input_bultos"></textarea>
				<textarea name="txt11" id="txt11" class="input_bultos"></textarea>
				<textarea name="txt12" id="txt12" class="input_descripcion"></textarea>

				<!-- input_valor: 13_1, 13_2, 14, 15: Peso, volumen, medidas -->
				<textarea name="txt13_1" id="txt13_1" class="input_valor"></textarea>
				<textarea name="txt13_2" id="txt13_2" class="input_valor"></textarea>
				<textarea name="txt14" id="txt14" class="input_valor"></textarea>
				<textarea name="txt15" id="txt15" class="input_valor"></textarea>

				<!-- input_incoterm -->
				<textarea name="txt16" id="txt16" class="input_incoterm"></textarea>

				<!-- input_valor -->
				<textarea name="txt17_11" id="txt17_11" class="input_valor"></textarea>
				<textarea name="txt17_12" id="txt17_12" class="input_valor"></textarea>
				<textarea name="txt17_13" id="txt17_13" class="input_valor"></textarea>
				<textarea name="txt17_14" id="txt17_14" class="input_valor"></textarea>
				<textarea name="txt17_21" id="txt17_21" class="input_general"></textarea>
				<textarea name="txt17_22" id="txt17_22" class="input_general"></textarea>
				<textarea name="txt17_23" id="txt17_23" class="input_general"></textarea>
				<textarea name="txt17_24" id="txt17_24" class="input_general"></textarea>
				<textarea name="txt17_31" id="txt17_31" class="input_valor"></textarea>
				<textarea name="txt17_32" id="txt17_32" class="input_valor"></textarea>
				<textarea name="txt17_33" id="txt17_33" class="input_valor"></textarea>
				<textarea name="txt17_34" id="txt17_34" class="input_valor"></textarea>
				<textarea name="txt17_41" id="txt17_41" class="input_general"></textarea>
				<textarea name="txt17_42" id="txt17_42" class="input_general"></textarea>
				<textarea name="txt17_43" id="txt17_43" class="input_general"></textarea>
				<textarea name="txt17_44" id="txt17_44" class="input_general"></textarea>

				<!-- Documentos, Emision, Representante, Instrucciones, Observaciones,
				Transportista -->
				<textarea name="txt18" id="txt18" class="input_documento"></textarea>

				<textarea name="txt19" id="txt19" class="input_lugar"></textarea>
				<textarea name="txt20" id="txt20" class="input_general"></textarea>
				<textarea name="txt21" id="txt21" class="input_general"></textarea>
				<textarea name="txt22" id="txt22" class="input_general"></textarea>
				<textarea name="txt23" id="txt23" class="input_general"></textarea>
				
				<!-- Tipo: Original o Copia -->
				<textarea name="txt24" id="txt24" class="input_tipo"></textarea>

				<!-- Add other input fields as needed -->
    			<input type="hidden" name="boton_pdf" id="boton_pdf" value="">
			</div>
		</form>
	</div>
<script>
		//-------------------------------------------------------------
		// Get input parameters from server and apply to form inputs
		//-------------------------------------------------------------
		let inputsParameters = {{ input_parameters|safe }};

		window.jsPDF = window.jspdf.jsPDF;
		let pdf = new jsPDF();

		let MAXLINES = "";
		let MAXCHARS = "";
		let FONTSIZE = "";
		let textArea = "";
		let text     = "";

		// Set restrictions and styles for each input textarea
		const textAreas = document.querySelectorAll ("textarea");
		textAreas.forEach (function (textArea) {
			const input = inputsParameters [textArea.id];
			textArea.style.fontSize  = input["fontSize"];
			textArea.style.textAlign = input["align"];
			textArea.style.position = "absolute";
			textArea.addEventListener ('input', handleInput);

		//	const className = textArea.className;
		//	input = inputsParameters [className]
		//	textArea.style.fontSize  = input["fontSize"];
		//	textArea.style.textAlign = "align" in input ? input["align"] : "left"
		//	textArea.style.position = "absolute";
		//	textArea.addEventListener ('input', handleInput);
		});

		// Control max number of lines and chars according to className
		function handleInput (event) {
			textArea = event.target;
			convertToUpperCase (textArea);

			MAXLINES = inputsParameters [textArea.id]["maxLines"];
			MAXCHARS = inputsParameters [textArea.id]["maxChars"] * 3.2;
//			const allClasses = textArea.className.split(" ");
//			const inputClass = allClasses.filter (str => str.startsWith ("input_"))
//			const className = inputClass [0]
//			MAXLINES = inputsParameters [className]["maxLines"];
//			MAXCHARS = inputsParameters [className]["maxChars"] * 3.2;
//			FONTSIZE = inputsParameters [className]["fontSize"];

			// Control maximum number of chars
			lines = pdf.splitTextToSize (textArea.value, MAXCHARS);
			textArea.value = lines.join("\n");

			// Control maximum number of lines
			text = textArea.value;
			lines = text.split('\n'); 
			if (lines.length > MAXLINES) 
				textArea.value = lines.slice (0, MAXLINES).join('\n');
		}

		// Save the current cursor position
		function convertToUpperCase (textArea) {
			var start = textArea.selectionStart;
			var end = textArea.selectionEnd;
			// Convert the text to uppercase and set it back to the textArea
			textArea.value = textArea.value.toUpperCase();
			// Restore the cursor position
			textArea.setSelectionRange(start, end);
		}

		//-------------------------------------------------------------
		// For handling "preliminar", "original", "copia", and "clonar" options
		// and getting preliminar document Id
		//-------------------------------------------------------------
		$(document).ready(function () {
			$('#forma_pdf').submit(function (e) {
				let formaPdf = this;
				let submitterButton = e["originalEvent"]["submitter"]["id"];
				document.getElementById('boton_pdf').value = submitterButton; 

				e.preventDefault();  // Prevent the default form submission
				var formData = $(this).serialize();

				$.ajax({
					type: 'POST',
					url: $(this).attr('action'),
					data: formData,

					 beforeSend: function (xhr, settings) {
					 	// Include the CSRF token in the request headers
					 	xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
					 },

					success: function (data) { // Handle the response from the server
						let input = document.getElementById("txt00")
						if (submitterButton.includes ("preliminar")){
							formaPdf.submit ();
						}else if (submitterButton.includes ("original")){
							if (input.value == "" || input.value == "PRELIMINAR" || input.value == "CLON")
								input.value = data ["numero"]
							formaPdf.submit ();
						}else if (submitterButton.includes ("copia")){
							if (typeof data == "string")  // PDF content
								formaPdf.submit ();
							else {                        // Object content
								alert ("Error: No se ha creado el documento original!")
							}
						}else if (submitterButton.includes ("clonar")){
							input.value = data ["numero"]
						}
					},
					error: function (data) { // Handle errors if any
							alert('Error submitting the form.');
					}
				});
			});


			// Scripts for autocomplete options in input fields
			empresaInputs = getTextAreasByClassName ("input_empresa")
			empresaInputs.forEach (inputName => {
				createAutocomplete(new AutoCompleteEmpresa (inputName)) 
			});
		});

		// Create autocomplete for an entity
		function createAutocomplete (entity) {
			inputSelector = entity.inputSelector
			sourceUrl     = entity.sourceUrl
			
			$(inputSelector).autocomplete({
				source: function (request, response) {
					$.ajax({ url: sourceUrl, dataType: 'json', data: { query: request.term},

						beforeSend: function (xhr, settings) {
							// Include the CSRF token in the request headers
							xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
						},

						success: function (data) {
							responseData = entity.onAjaxSuccess (data)
							response (responseData)
						}
					});
				},
				minLength: 2, 
				select: function (event, ui) {
					entity.onItemSelected (ui)
					// Prevent the default behavior of filling the input with the selected value
					return false;
				}
			});
		}

		// Autocomplete class for Empresa inputs
		class AutoCompleteEmpresa {
			constructor (inputSelector) {
				let inputId = "#" + inputSelector
				this.inputSelector = inputSelector;
				this.sourceUrl     = "opciones-empresa/"
				this.fullData = null;
			}

			// When ajax query is succesfull, set items
			onAjaxSuccess (data) {
				this.fullData = data;
				let flatData = [];
				for (let i=0; i < data.length; i++) {
					flatData.push (data[i] ["itemLine"])
				}
				return flatData;
			}

			// When an item is selected, populate the textarea 
			onItemSelected (ui) {
				let index = ui.item.value.split (".")[0]
				let text = this.fullData [index]["itemText"]
				$(this.inputSelector).val (text);
			}
		}

		// Return array of selected textAreas according to className
		function getTextAreasByClassName (className) {
			let selectedTextAreas = []
			textAreas.forEach (textArea => {
				if (textArea.className.includes (className)) {
					//console.log ("textArea", textArea)
					selectedTextAreas.push (textArea)
				}
			});
			return (selectedTextAreas);
		}


</script>
</body>
</html>

 
